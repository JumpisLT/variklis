<!DOCTYPE html>
<html lang="lt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Variklio Valdymo Pultas</title>

  <style>
    :root {
      --primary: #007bff;
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #333;
    }

    body {
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      padding: 20px;
      margin: 0;
    }

    .container {
      background: var(--card);
      padding: 60px 25px 25px 25px; /* vieta vėliavoms */
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
      position: relative;
      overflow: visible;
    }

    h2 { text-align: center; margin-top: 0; color: #1a1a1a; }

    /* --- Kalbos perjungimas --- */
    .lang-switch {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 10px;
      z-index: 9999;
      align-items: center;
    }

    .flag-btn {
      border: 2px solid transparent;
      background: #fff;
      padding: 0;
      width: 42px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
      transition: 0.15s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .flag-btn:hover { transform: scale(1.06); }

    .flag-btn.active {
      border-color: var(--primary);
      box-shadow: 0 6px 16px rgba(0,0,0,0.16);
    }

    .flag-svg { width: 100%; height: 100%; display: block; }

    /* --- Status --- */
    .status-box {
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      transition: 0.3s;
      background: #ffebee;
      color: #c62828;
    }
    .status-box.online {
      background: #e8f5e9;
      color: #2e7d32;
    }

    /* --- Controls --- */
    .control-group {
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 15px;
      background: #fafafa;
    }

    label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      font-size: 14px;
      color: #666;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 5px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
      margin-bottom: 15px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: var(--primary);
      border-radius: 50%;
      cursor: pointer;
    }

    .val-display {
      float: right;
      color: var(--primary);
      font-weight: bold;
      font-size: 18px;
    }

    button.ui-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: 0.2s;
    }

    .btn-connect {
      background: #333;
      color: white;
      margin-bottom: 20px;
    }
    .btn-connect:active { transform: scale(0.98); }

    .btn-save {
      background: var(--primary);
      color: white;
    }
    .btn-save:hover { background: #0056b3; }
    .btn-save:disabled { background: #ccc; cursor: not-allowed; }

    .hint {
      font-size: 12px;
      color: #999;
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="lang-switch" aria-label="Language switch">
      <!-- LT vėliava (SVG) -->
      <button class="flag-btn" id="btnLT" title="Lietuvių" aria-label="Lietuvių">
        <svg class="flag-svg" viewBox="0 0 3 2" xmlns="http://www.w3.org/2000/svg">
          <rect width="3" height="2" fill="#BE3A34"/>
          <rect width="3" height="1.333333" y="0" fill="#006A44"/>
          <rect width="3" height="0.666666" y="0" fill="#FDB913"/>
        </svg>
      </button>

      <!-- EN vėliava (SVG, supaprastinta UK) -->
      <button class="flag-btn" id="btnEN" title="English" aria-label="English">
        <svg class="flag-svg" viewBox="0 0 60 30" xmlns="http://www.w3.org/2000/svg">
          <rect width="60" height="30" fill="#012169"/>
          <!-- baltos įstrižainės -->
          <path d="M0,0 L7,0 L60,23 L60,30 L53,30 L0,7 Z" fill="#FFFFFF" opacity="0.95"/>
          <path d="M60,0 L53,0 L0,23 L0,30 L7,30 L60,7 Z" fill="#FFFFFF" opacity="0.95"/>
          <!-- raudonos įstrižainės -->
          <path d="M0,0 L4.5,0 L60,22.5 L60,27 L55.5,27 L0,4.5 Z" fill="#C8102E"/>
          <path d="M60,0 L55.5,0 L0,22.5 L0,27 L4.5,27 L60,4.5 Z" fill="#C8102E"/>
          <!-- baltas kryžius -->
          <rect x="24" y="0" width="12" height="30" fill="#FFFFFF"/>
          <rect x="0" y="9" width="60" height="12" fill="#FFFFFF"/>
          <!-- raudonas kryžius -->
          <rect x="26.5" y="0" width="7" height="30" fill="#C8102E"/>
          <rect x="0" y="11.5" width="60" height="7" fill="#C8102E"/>
        </svg>
      </button>
    </div>

    <h2 data-i18n="title">Valdiklio Nustatymai</h2>

    <div id="status" class="status-box" data-i18n="status_disconnected">Neprisijungta</div>

    <button id="connectBtn" class="ui-btn btn-connect" data-i18n="connect">
      Prisijungti per Bluetooth
    </button>

    <div class="control-group">
      <label>
        <span data-i18n="slow_speed">LĖTAS GREITIS</span>
        <span id="sDisp" class="val-display">--%</span>
      </label>
      <input type="range" id="sRange" min="0" max="100" value="30" oninput="dUpdate('sDisp', this.value)">
      <button id="sBtn" class="ui-btn btn-save btn-save" onclick="send('S', 'sRange')" disabled data-i18n="save">
        Išsaugoti
      </button>
    </div>

    <div class="control-group">
      <label>
        <span data-i18n="medium_speed">VIDUTINIS GREITIS</span>
        <span id="mDisp" class="val-display">--%</span>
      </label>
      <input type="range" id="mRange" min="0" max="100" value="60" oninput="dUpdate('mDisp', this.value)">
      <button id="mBtn" class="ui-btn btn-save" onclick="send('M', 'mRange')" disabled data-i18n="save">
        Išsaugoti
      </button>
    </div>

    <div class="control-group">
      <label>
        <span data-i18n="max_speed">MAKSIMALUS GREITIS</span>
        <span id="fDisp" class="val-display">--%</span>
      </label>
      <input type="range" id="fRange" min="0" max="100" value="95" oninput="dUpdate('fDisp', this.value)">
      <button id="fBtn" class="ui-btn btn-save" onclick="send('F', 'fRange')" disabled data-i18n="save">
        Išsaugoti
      </button>
    </div>

    <p class="hint" data-i18n="hint">Prisijungus bus nuskaityti esami nustatymai</p>
  </div>

  <script>
    // --- i18n ---
    const I18N = {
      lt: {
        title: "Valdiklio Nustatymai",
        status_disconnected: "Neprisijungta",
        status_searching: "Ieškoma...",
        status_connected: "PRISIJUNGTA",
        status_connect_error: "Klaida prisijungiant",
        connect: "Prisijungti per Bluetooth",
        slow_speed: "LĖTAS GREITIS",
        medium_speed: "VIDUTINIS GREITIS",
        max_speed: "MAKSIMALUS GREITIS",
        save: "Išsaugoti",
        hint: "Prisijungus bus nuskaityti esami nustatymai",
        alert_saved: "Nustatymas išsaugotas!",
        alert_save_failed: "Nepavyko išsaugoti. Bandykite dar kartą.",
        read_error: "Nuskaitymo klaida:"
      },
      en: {
        title: "Controller Settings",
        status_disconnected: "Disconnected",
        status_searching: "Searching...",
        status_connected: "CONNECTED",
        status_connect_error: "Connection error",
        connect: "Connect via Bluetooth",
        slow_speed: "SLOW SPEED",
        medium_speed: "MEDIUM SPEED",
        max_speed: "MAX SPEED",
        save: "Save",
        hint: "After connecting, current settings will be read",
        alert_saved: "Setting saved!",
        alert_save_failed: "Could not save. Please try again.",
        read_error: "Read error:"
      }
    };

    let currentLang = "lt";

    function t(key) {
      return (I18N[currentLang] && I18N[currentLang][key]) ? I18N[currentLang][key] : key;
    }

    function applyTranslations() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = t(key);
      });

      document.documentElement.lang = currentLang;

      document.getElementById("btnLT").classList.toggle("active", currentLang === "lt");
      document.getElementById("btnEN").classList.toggle("active", currentLang === "en");
    }

    function setLanguage(lang) {
      currentLang = (lang === "en") ? "en" : "lt";
      localStorage.setItem("lang", currentLang);

      // jei statusas turi raktą, jį irgi išverčiam
      const statusEl = document.getElementById("status");
      const rawKey = statusEl.getAttribute("data-status-key");
      if (rawKey) statusEl.textContent = t(rawKey);

      applyTranslations();
    }

    (function initLanguage() {
      const saved = localStorage.getItem("lang");
      if (saved === "en" || saved === "lt") currentLang = saved;
      applyTranslations();
    })();

    document.getElementById("btnLT").addEventListener("click", () => setLanguage("lt"));
    document.getElementById("btnEN").addEventListener("click", () => setLanguage("en"));

    // --- BLE logic ---
    let device, characteristic;
    const serviceUuid = "4fafc201-1fb5-459e-8fcc-c5c9c331914b";
    const charUuid = "beb5483e-36e1-4688-b7f5-ea07361b26a8";

    function dUpdate(id, val) {
      document.getElementById(id).innerText = val + "%";
    }

    function setStatus(key, online=false) {
      const s = document.getElementById("status");
      s.setAttribute("data-status-key", key);
      s.innerText = t(key);
      s.classList.toggle("online", !!online);
    }

    document.getElementById("connectBtn").onclick = async () => {
      try {
        setStatus("status_searching", false);

        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: "Variklio_Valdiklis" }],
          optionalServices: [serviceUuid]
        });

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(serviceUuid);
        characteristic = await service.getCharacteristic(charUuid);

        setStatus("status_connected", true);
        document.getElementById("connectBtn").style.display = "none";
        document.querySelectorAll(".btn-save").forEach(btn => btn.disabled = false);

        await readSettings();
      } catch (error) {
        console.error(error);
        setStatus("status_connect_error", false);
      }
    };

    async function readSettings() {
      if (!characteristic) return;
      try {
        const value = await characteristic.readValue();
        const decoder = new TextDecoder("utf-8");
        const dataString = decoder.decode(value);

        // Formatas iš ESP32: "S30,M60,F95"
        const parts = dataString.split(",");
        parts.forEach(part => {
          const type = part.charAt(0);
          const val = part.substring(1);
          if (type === "S") { document.getElementById("sRange").value = val; dUpdate("sDisp", val); }
          if (type === "M") { document.getElementById("mRange").value = val; dUpdate("mDisp", val); }
          if (type === "F") { document.getElementById("fRange").value = val; dUpdate("fDisp", val); }
        });
      } catch (error) {
        console.error(t("read_error"), error);
      }
    }

    async function send(prefix, inputId) {
      if (!characteristic) return;
      const val = document.getElementById(inputId).value;
      const data = new TextEncoder().encode(prefix + val);
      try {
        await characteristic.writeValue(data);
        alert(t("alert_saved"));
      } catch (e) {
        alert(t("alert_save_failed"));
      }
    }
  </script>
</body>
</html>
